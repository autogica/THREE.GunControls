<!DOCTYPE html>
<html lang="en">

<head>
  <title>three.js webgl - geometry - cube</title>
  <meta charset="utf-8">
  <style>
    body {
      margin: 0px;
      background-color: #000000;
      overflow: hidden;
    }
  </style>
</head>

<body>

  <script src="three.min.js"></script>
  <script src="THREE.GunControl.js"></script>
  <script src="THREE.OrbitControls.js"></script>

  <script>
    var config = {
    	pivotLength: 300
    };
    var camera, scene, renderer;
    var controls;
    var ws;
    var gunControl;
    var gunReady = false;

    function init() {



    	camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 50000);

    	camera.position.set(300, 300, 400);
    	camera.up = new THREE.Vector3(0, 1, 0);
    	camera.lookAt(new THREE.Vector3(0, 0, 0));

    	scene = new THREE.Scene();
    	scene.fog = new THREE.FogExp2(0xcccccc, 0.001);

    	controls = new THREE.OrbitControls(camera);
    	controls.damping = 0.2;
    	//controls.addEventListener( 'change', render );


    	light = new THREE.DirectionalLight(0xffffff);
    	light.position.set(1, 1, 1);
    	scene.add(light);
    	light = new THREE.DirectionalLight(0x002288);
    	light.position.set(-1, -1, -1);
    	scene.add(light);
    	light = new THREE.AmbientLight(0x222222);
    	scene.add(light);

    	var geometry = new THREE.PlaneGeometry(160, 90, 32);
    	var material = new THREE.MeshBasicMaterial({
    		color: 0xe3e9f1,
    		side: THREE.DoubleSide
    	});
    	var plane = new THREE.Mesh(geometry, material);
    	scene.add(plane);

    	var loader = new THREE.JSONLoader(); // init the loader util

    	// init loading
    	loader.load('models/gun.json', function(geometry) {
    		// create a new material
    		var material = new THREE.MeshLambertMaterial({
    			//map: THREE.ImageUtils.loadTexture('path_to_texture'),  // specify and load the texture
    			colorAmbient: [0.480000026226044, 0.480000026226044, 0.480000026226044],
    			colorDiffuse: [0.480000026226044, 0.480000026226044, 0.480000026226044],
    			colorSpecular: [0.8999999761581421, 0.8999999761581421, 0.8999999761581421],
    			shading: THREE.FlatShading
    		});

    		// create a mesh with models geometry and material
    		var gunAssembly = new THREE.Mesh(
    			geometry,
    			material
    		);
    		gunAssembly.rotation.x = +Math.PI / 2;
    		gunAssembly.rotation.y = -Math.PI;
    		gunAssembly.rotation.z = -Math.PI / 2;
    		gunAssembly.position.z = -5;
    		gunAssembly.position.y = 100;
    		gunAssembly.scale.x = 5; // SCALE
    		gunAssembly.scale.y = 5; // SCALE
    		gunAssembly.scale.z = 5; // SCALE

    		var handPivot = new THREE.Object3D();
    		handPivot.position.z = 250;
    		handPivot.position.y = -30;
    		handPivot.add(gunAssembly);

    		var dir = new THREE.Vector3(0, 1, 0);
    		var origin = new THREE.Vector3(0, 0, 0);
    		var length = 600;
    		var hex = 0xff0000;

    		var arrowHelper = new THREE.ArrowHelper(dir, origin, length, hex);
    		handPivot.add(arrowHelper);

    		dir = new THREE.Vector3(1, 0, 0);
    		origin = new THREE.Vector3(0, 0, 0);
    		length = 30;
    		hex = 0x00ff00;

    		arrowHelper = new THREE.ArrowHelper(dir, origin, length, hex);
    		handPivot.add(arrowHelper);

    		dir = new THREE.Vector3(0, 0, 1);
    		origin = new THREE.Vector3(0, 0, 0);
    		length = 20;
    		hex = 0x0000ff;

    		arrowHelper = new THREE.ArrowHelper(dir, origin, length, hex);
    		handPivot.add(arrowHelper);

    		scene.add(handPivot);


    		gunControl = new THREE.GunControls(handPivot);
    		gunControl.connect();
    		gunReady = true;
    	});


    	renderer = new THREE.WebGLRenderer();
    	renderer.setClearColor(scene.fog.color);
    	renderer.setPixelRatio(window.devicePixelRatio);
    	renderer.setSize(window.innerWidth, window.innerHeight);
    	document.body.appendChild(renderer.domElement);


    	window.addEventListener('resize', onWindowResize, false);

    	animate();



    	ws = new WebSocket("ws://192.168.0.31:8088/");

    	console.log("we are a display");

    	ws.onmessage = function(event) {
    		var msg = JSON.parse(event.data);
    		//console.log("msg:", msg);
    		if (msg.type === "hello") {
    			console.log("server said hello, replying..");
    			ws.send(JSON.stringify({
    				type: "display"
    			}));
    		} else if (msg.type === "sensor") {
    			if (gunReady)
    				gunControl.write(msg.sensor);
    		}
    	}

    }


    function onWindowResize() {

    	camera.aspect = window.innerWidth / window.innerHeight;
    	camera.updateProjectionMatrix();

    	renderer.setSize(window.innerWidth, window.innerHeight);

    }

    function animate() {

    	requestAnimationFrame(animate);

    	if (gunReady) gunControl.update();

    	renderer.render(scene, camera);

    }

    init();
  </script>

</body>

</html>
